//synchronous = solidity
//asynchronous = javascript
const ethers = require("ethers")
const fs = require("fs-extra")
require("dotenv").config()

//la programacion asincrona sirve para ejecutar metodos
//mientras otros estan siendo ejecutados

async function main() {
    //deploy a contract? wait for it to be deployed
    //contract.deploy -> wouldnt wait for it to finish
    //http://127.0.0.1:7545
    const provider = new ethers.providers.JsonRpcBatchProvider(
        "http://127.0.0.1:7545"
        //aqui va el servidor rpc de la blockchain a la que nos vamos a conectar
        //para obtener datos y desplegar contratos
    )

    //usamos las variables de entorno con el .env para el servidor RPC
    //incluyendo require("dotenv").config();
    const provider2 = new ethers.providers.JsonRpcBatchProvider(
        process.env.RPC_URL
        //aqui va el servidor rpc de la blockchain a la que nos vamos a conectar
        //para obtener datos y desplegar contratos
    )

    //creacion de wallet con clave privada para poder firmar las transacciones

    const wallet = new ethers.Wallet(
        "94d8a88094e3ee06d57781f45fcd2cb5f2c91d47c1e5f81d1b6b32871f69213c",
        provider2
    )

    //no es bueno tener la private key en codigo hacemos un .env
    //const wallet2 = new ethers.Wallet(process.env.PRIV_KEY, provider2);

    //se puede mejorar la creacion y gestion de la billetera encriptando la clave privada del .env y eliminandola
    // creando un script .encryotedKey.json que luego se añadirá al .gitignore
    const encyptedJson = fs.readFileSync("./.encryptedKey.json", "utf-8")
    let wallet3 = new ethers.Wallet.fromEncryptedJsonSync(
        encyptedJson,
        process.env.PRIV_KEY_PASS
    )

    wallet3 = await wallet3.connect(provider2)

    const abi = fs.readFileSync(
        "./SimpleStorage_sol_SimpleStorage.json",
        "utf-8"
    )
    const binary = fs.readFileSync(
        "./SimpleStorage_sol_SimpleStorage.bin",
        "utf-8"
    )

    //en las funciones asincronas podemos utilizar la keyword
    //await, que significa que debe esperarse a que la promesa que se devuelve sea
    //aceptada o rechazada para pasar a la siguiente ejecucion

    // async function setUpMovie() {
    //   await cookPopcorn();
    //   await pourDrinks();
    // }

    const contractFactory = new ethers.ContractFactory(abi, binary, wallet3)
    console.log("Deploying, please wait...")
    //const contract = await contractFactory.deploy({gasPrice:1000000000}); //wait contract deploying

    const contract = await contractFactory.deploy() //podemos modificar gasPrice y gasLimit como argumentos
    await contract.deployTransaction.wait(1) //esto muestra la informacion de la transaccion del deploy del contrato, espera confirmacion de 1 bloque
    /*console.log("Deployment transaction: ");
  console.log(contract.deployTransaction); //esto es la transaccion del lanzamiento del contrato
  console.log("Transaction receipt:");
  console.log(deploymentReceipt); esto es la transaccion que se obtiene cuando se recibe una confirmacion de bloque*/

    //ESTO ES PARA MANDAR TRANSACCIONES
    //////////////////////

    // console.log("Deploy with only transaction data");
    // const nonce = await wallet.getTransactionCount();
    // const tx = {
    //   nonce: nonce, //el valor de nonce para cada transaccion es unica, las billeteras usan un valor para cada transaccion
    //   gasPrice: 20000000000,
    //   gasLimit: 1000000,
    //   to: null,
    //   value: 0,
    //   data: "0x608060405260056001556040518060400160405280600481526020017f4669766500000000000000000000000000000000000000000000000000000000815250600290816200004f9190620003ec565b507ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffb600355735b38da6a701c568545dcfcb03fcb875f56beddc4600460006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055507f63617400000000000000000000000000000000000000000000000000000000006005556040518060400160405280600281526020016040518060400160405280600581526020017f6a686f6e7900000000000000000000000000000000000000000000000000000081525081525060076000820151816000015560208201518160010190816200015b9190620003ec565b5050503480156200016b57600080fd5b50620004d3565b600081519050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b60006002820490506001821680620001f457607f821691505b6020821081036200020a5762000209620001ac565b5b50919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b600060088302620002747fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8262000235565b62000280868362000235565b95508019841693508086168417925050509392505050565b6000819050919050565b6000819050919050565b6000620002cd620002c7620002c18462000298565b620002a2565b62000298565b9050919050565b6000819050919050565b620002e983620002ac565b62000301620002f882620002d4565b84845462000242565b825550505050565b600090565b6200031862000309565b62000325818484620002de565b505050565b5b818110156200034d57620003416000826200030e565b6001810190506200032b565b5050565b601f8211156200039c57620003668162000210565b620003718462000225565b8101602085101562000381578190505b62000399620003908562000225565b8301826200032a565b50505b505050565b600082821c905092915050565b6000620003c160001984600802620003a1565b1980831691505092915050565b6000620003dc8383620003ae565b9150826002028217905092915050565b620003f78262000172565b67ffffffffffffffff8111156200041357620004126200017d565b5b6200041f8254620001db565b6200042c82828562000351565b600060209050601f8311600181146200046457600084156200044f578287015190505b6200045b8582620003ce565b865550620004cb565b601f198416620004748662000210565b60005b828110156200049e5784890151825560018201915060208501945060208101905062000477565b86831015620004be5784890151620004ba601f891682620003ae565b8355505b6001600288020188555050505b505050505050565b610bc980620004e36000396000f3fe608060405234801561001057600080fd5b50600436106100935760003560e01c80636f760f41116100665780636f760f411461012057806377ec2b551461013c578063809ca3ae1461015b5780639e7a13ad14610177578063dcc69905146101a857610093565b80632e64cec11461009857806343ec8f47146100b657806343ede4ae146100e65780636057361d14610104575b600080fd5b6100a06101d9565b6040516100ad9190610537565b60405180910390f35b6100d060048036038101906100cb91906106ac565b6101e3565b6040516100dd9190610537565b60405180910390f35b6100ee610211565b6040516100fb9190610537565b60405180910390f35b61011e60048036038101906101199190610721565b610217565b005b61013a6004803603810190610135919061074e565b610221565b005b61014461028d565b604051610152929190610832565b60405180910390f35b6101756004803603810190610170919061074e565b610327565b005b610191600480360381019061018c9190610721565b6103b0565b60405161019f929190610832565b60405180910390f35b6101c260048036038101906101bd9190610721565b61046c565b6040516101d0929190610832565b60405180910390f35b6000600154905090565b6006818051602081018201805184825260208301602085012081835280955050505050506000915090505481565b60015481565b8060018190555050565b60006040518060400160405280838152602001848152509050600f8190806001815401808255809150506001900390600052602060002090600202016000909190919091506000820151816000015560208201518160010190816102859190610a6e565b505050505050565b60078060000154908060010180546102a490610891565b80601f01602080910402602001604051908101604052809291908181526020018280546102d090610891565b801561031d5780601f106102f25761010080835404028352916020019161031d565b820191906000526020600020905b81548152906001019060200180831161030057829003601f168201915b5050505050905082565b600f60405180604001604052808381526020018481525090806001815401808255809150506001900390600052602060002090600202016000909190919091506000820151816000015560208201518160010190816103869190610a6e565b5050508060068360405161039a9190610b7c565b9081526020016040518091039020819055505050565b600f81815481106103c057600080fd5b90600052602060002090600202016000915090508060000154908060010180546103e990610891565b80601f016020809104026020016040519081016040528092919081815260200182805461041590610891565b80156104625780601f1061043757610100808354040283529160200191610462565b820191906000526020600020905b81548152906001019060200180831161044557829003601f168201915b5050505050905082565b6009816003811061047c57600080fd5b6002020160009150905080600001549080600101805461049b90610891565b80601f01602080910402602001604051908101604052809291908181526020018280546104c790610891565b80156105145780601f106104e957610100808354040283529160200191610514565b820191906000526020600020905b8154815290600101906020018083116104f757829003601f168201915b5050505050905082565b6000819050919050565b6105318161051e565b82525050565b600060208201905061054c6000830184610528565b92915050565b6000604051905090565b600080fd5b600080fd5b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6105b982610570565b810181811067ffffffffffffffff821117156105d8576105d7610581565b5b80604052505050565b60006105eb610552565b90506105f782826105b0565b919050565b600067ffffffffffffffff82111561061757610616610581565b5b61062082610570565b9050602081019050919050565b82818337600083830152505050565b600061064f61064a846105fc565b6105e1565b90508281526020810184848401111561066b5761066a61056b565b5b61067684828561062d565b509392505050565b600082601f83011261069357610692610566565b5b81356106a384826020860161063c565b91505092915050565b6000602082840312156106c2576106c161055c565b5b600082013567ffffffffffffffff8111156106e0576106df610561565b5b6106ec8482850161067e565b91505092915050565b6106fe8161051e565b811461070957600080fd5b50565b60008135905061071b816106f5565b92915050565b6000602082840312156107375761073661055c565b5b60006107458482850161070c565b91505092915050565b600080604083850312156107655761076461055c565b5b600083013567ffffffffffffffff81111561078357610782610561565b5b61078f8582860161067e565b92505060206107a08582860161070c565b9150509250929050565b600081519050919050565b600082825260208201905092915050565b60005b838110156107e45780820151818401526020810190506107c9565b838111156107f3576000848401525b50505050565b6000610804826107aa565b61080e81856107b5565b935061081e8185602086016107c6565b61082781610570565b840191505092915050565b60006040820190506108476000830185610528565b818103602083015261085981846107f9565b90509392505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b600060028204905060018216806108a957607f821691505b6020821081036108bc576108bb610862565b5b50919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b6000600883026109247fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff826108e7565b61092e86836108e7565b95508019841693508086168417925050509392505050565b6000819050919050565b600061096b6109666109618461051e565b610946565b61051e565b9050919050565b6000819050919050565b61098583610950565b61099961099182610972565b8484546108f4565b825550505050565b600090565b6109ae6109a1565b6109b981848461097c565b505050565b5b818110156109dd576109d26000826109a6565b6001810190506109bf565b5050565b601f821115610a22576109f3816108c2565b6109fc846108d7565b81016020851015610a0b578190505b610a1f610a17856108d7565b8301826109be565b50505b505050565b600082821c905092915050565b6000610a4560001984600802610a27565b1980831691505092915050565b6000610a5e8383610a34565b9150826002028217905092915050565b610a77826107aa565b67ffffffffffffffff811115610a9057610a8f610581565b5b610a9a8254610891565b610aa58282856109e1565b600060209050601f831160018114610ad85760008415610ac6578287015190505b610ad08582610a52565b865550610b38565b601f198416610ae6866108c2565b60005b82811015610b0e57848901518255600182019150602085019450602081019050610ae9565b86831015610b2b5784890151610b27601f891682610a34565b8355505b6001600288020188555050505b505050505050565b600081905092915050565b6000610b56826107aa565b610b608185610b40565b9350610b708185602086016107c6565b80840191505092915050565b6000610b888284610b4b565b91508190509291505056fea264697066735822122060a4eaecda39cf20fae5ae6c40ac6c6d46d73d47dc3f16a672573e0a4a0a459c64736f6c634300080f0033",
    //   //data es el contenido del binario SimpleStorage_sol_....bin
    //   chainId: 5777,
    // };

    // //const signedTxResponse = await wallet.signTransaction(tx); esto no es necesario ya que en el metodo send transaction ya ejecuta sign transaction
    // const sentTxResponse = await wallet.sendTransaction(tx);
    // await sentTxResponse.wait(1); //esperamos una confirmacion de bloque para continuar
    // console.log(sentTxResponse);

    ///////////////////////////////////////

    //VAMOS A HACERLO MAS FACIL interactuando con el contrato con su abi
    const currentFavNumber = await contract.retrieve()
    console.log(`Current fav number: ${currentFavNumber.toString()}`)

    const txResponse = await contract.store("7")
    const txReceipt = await txResponse.wait(1)
    const updatedFavNumber = await contract.retrieve()
    console.log(`Updated favorite number is: ${updatedFavNumber}`)
    //hacemos esto porque contract.store devuelve una transaccion y luego debe esperarse una confirmacion de bloque para obtener los datos de la transaccion
}

main()
    .then(() => process.exit(0))
    .catch((error) => {
        console.error(error)
        process.exit(1)
    })

//ganache es una fake blockchain local para probar cosas

//go-ethereum es para tener nodos propios

//alchemy nos proporciona un nodo para desplegar contratos
